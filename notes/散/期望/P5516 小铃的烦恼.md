---
tags: Mathematical_expectation
type: solution
---
由于不确定哪个属性才是最终的属性，考虑枚举
则由全期望公式
$$
E(所有颜色相同)=\sum_{i=1}^n E(所有变为第i个)P(第i个是最终颜色)
$$
分别计算概率和期望
由于
$$
\sum_{a=1}^n\sum_{b=1}^n p_{a,b}=n^2
$$
所以每次操作都是必定成功的
假设当前局面剩余 $k$ 种目标最终局面颜色，那么会使局面产生变化的情况有两种：
1. $a$ 取目标最终局面颜色， $b$ 取其他颜色，这令目标颜色 $+1$
2. $a$ 取其他颜色， $b$ 取目标最终局面颜色，这令目标颜色 $-1$
两种的概率都是 $\dfrac{k(n-k)}{n(n-1)}$，总共概率为 $\dfrac{2k(n-k)}{n(n-1)}$
假设 $p_k$ 表示当前有 $k$ 个目标颜色时，目标颜色变为终局颜色的概率
那么
$$
\begin{equation}
\begin{aligned}
p_k
&=p_{k-1}\dfrac{k(n-k)}{n(n-1)}+p_{k+1}\dfrac{k(n-k)}{n(n-1)}+(1-2\dfrac{k(n-k)}{n(n-1)})p_k\\
\dfrac{2k(n-k)}{n(n-1)}
&=p_{k-1}\dfrac{k(n-k)}{n(n-1)}+p_{k+1}\dfrac{k(n-k)}{n(n-1)}\\
2p_k
&=p_{k-1}+p_{k+1}
\end{aligned}
\end{equation}
$$
则
$$
p_k=\dfrac{p_{k-1}+p_{k+1}}{2}
$$
这是一个等差数列，因为
$$
\begin{equation}
\begin{aligned}
p_{k+1}-p_k
&=p_{k+1}-\dfrac{p_{k-1}+p_{k+1}}{2}\\
&=\dfrac{p_{k+1}-p_{k-1}}{2}\\
p_{k}-p_{k-1}
&=\dfrac{p_{k+1}+p_{k-1}}{2}-p_{k-1}\\
&=\dfrac{p_{k+1}-p_{k-1}}{2}\\
p_{k+1}-p_k&=p_k - p_{k-1}
\end{aligned}
\end{equation}
$$
根据定义有
$$
p_0=0, p_n=1
$$
所以
$$
\forall i\in [0,n],p_k=\dfrac{k}{n}
$$
考虑期望
设 $f_k$ 表示==有解时==目标颜色有 $k$ 个，目标颜色变为终局颜色的期望步数
注意到单纯的 $f_k$ 预设了有解的条件，是条件期望，所以在转移到其他时要乘上有解的概率
用全期望把 $f_k$ 拆开，先计算由 $k$ 种目标颜色到 $k\pm 1$ 的期望步数，再计算 $k\pm 1$ 到终局的期望
考虑由 $k$ 到 $k\pm 1$ 的期望步数
有三种情况，分别是不变，$+1$ 和 $-1$，称后两种情况为变化
变化的概率是 $\dfrac{2k(n-k)}{n(n-1)}$
考虑第一次变化出现的期望步数，由于每次操作彼此独立，是伯努利试验，不难发现是这是一个几何分布
则第一次变化的期望步数是概率的倒数
$$
\dfrac{n(n-1)}{2k(n-k)}
$$
考虑了由 $k$ 到 $k\pm 1$ 的贡献
接下来考虑由 $k\pm 1$ 到终局的期望
假设 $T_k$ 表示当有 $k$ 种目标颜色时，该目标颜色变成终局颜色的事件
$k+1$ 的贡献是 $E(T_{k+1})P(T_{k+1})$ 
$$
f_{k+1}p_{k+1}
$$
因为转移过来是有解的情况下的，需要乘上有解的概率
$k-1$ 的贡献同理
$$
f_{k-1}p_{k-1}
$$

最终
$$
f_kp_k=\dfrac{n(n-1)p_k}{2k(n-k)}+\frac{1}{2}f_{k+1}p_{k+1}+\frac{1}{2}f_{k-1}p_{k-1}
$$
后面两个乘上 $\frac{1}{2}$ 是 $k$ 转移到 $k+1$ 和 $k-1$ 概率均等
$$
\dfrac{n(n-1)p_k}{2k(n-k)}=f_kp_k+\frac{1}{2}f_{k+1}p_{k+1}-
\frac{1}{2}f_{k-1}p_{k-1}
$$
$p$ 我们知道，可以继续展开
$$
\dfrac{k(n-1)}{2k(n-k)}=f_k\frac{k}{n}-\dfrac{k+1}{2n}f_{k+1}-\dfrac{k-1}{2n}f_{k-1}
$$
约一下有
$$
\dfrac{n(n-1)}{2k(n-k)}=f_k-\dfrac{k+1}{2k}f_{k+1}-\dfrac{k-1}{2k}f_{k-1}
$$
据定义 $f_n=0$
这个方程没法转移，但是可以高斯消元
不妨考虑一下这个矩阵的样子
以 $4\times 4$ 为例，系数矩阵大概是
$$
\begin{bmatrix}
1& -1& 0& 0&\\
-\frac{1}{2}& 1& -\frac{3}{4}& 0&\\
0& -\frac{1}{3}& 1& -\frac{2}{3}&\\
0& 0& -\frac{3}{8}& 1&\\
\end{bmatrix}
$$
所以第 $i$ 行只要消掉第 $i+1$ 行即可
在消完第 $i$ 行之后，把第 $i$ 行所有数同除 $A_{i,i}$ 可以把 $A_{i,i}$ 变为 $1$，只用记录 $A_{i,i+1}$ 和 $A_{i, n+1}$ 即可
假设前 $i-1$ 行都已经消完了，如何消第 $i$ 行
$A_{i-1,i-1}$ 为 $1$，那先算出 $A_{i,i-1}$ 的值 
其值为 $-\dfrac{i-1}{2i}$
所以给矩阵 $A$ 此时的第 $i-1$ 行乘上 $-\dfrac{i-1}{2i}$，令这一行减去上一行
那么 $A_{i,i-1}$ 此时为 $0$，不管
$A_{i,i}$ 变为 $A_{i,i}-\dfrac{i-1}{2i}A_{i-1,i}$
由于 $A_{i,i}=1$，这个式子是
$$
1-\dfrac{i-1}{2i}A_{i-1,i}
$$
$A_{i,i+1}$ 不变，算出来之后除以这个式子即可，$A_{i,n+1}$ 同理
